<!doctype html>
<html>
<head>
<meta charset="utf-8"> 
<title>Simple SFU - Home</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div id="roomModal" class="modal">
  <div class="modal-content">
    <h2>Create Room</h2>
    <div class="form-group">
      <label for="meetingTitle">Room Title</label>
      <input id="meetingTitle" type="text" placeholder="Enter room title" maxlength="100" />
      <small id="titleCounter">0/100 characters</small>
    </div>
    <div class="form-group">
      <label for="meetingType">Room Type</label>
      <select id="meetingType">
        <option value="">Select type</option>
        <option value="debate">Debate</option>
        <option value="unpopular-opinion">Unpopular Opinion</option>
        <option value="ragebait">Ragebait</option>
        <option value="discuss">Discuss</option>
        <option value="other">Other</option>
      </select>
    </div>
    
    <div class="form-group">
        <small style="color: #888;">* A unique Room ID will be generated automatically.</small>
    </div>

    <div>
      <button class="btn-primary" onclick="submitRoomDetails()">Create & Join</button>
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="container">
  <h2>Room Management</h2>
  <div>
    <button onclick="showCreateRoomModal()">Create New Room</button>
    <span style="margin: 0 10px;">OR</span>
    <input id="roomInput" type="text" placeholder="Enter room ID to join" style="padding: 5px; width: 200px;" />
    <button onclick="joinExistingRoom()">Join Existing Room</button>
  </div>
</div>

<div class="container">
  <h2>Active Rooms</h2>
  <button onclick="refreshRooms()">Refresh</button>
  <div id="activeRooms" style="margin-top: 10px;">
    <p style="color: #666;">Loading rooms...</p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const titleInput = document.getElementById('meetingTitle')
  if (titleInput) {
    titleInput.addEventListener('input', (e) => {
      const counter = document.getElementById('titleCounter')
      counter.textContent = `${e.target.value.length}/100 characters`
    })
  }
  refreshRooms()
  setInterval(refreshRooms, 5000)
})

async function refreshRooms() {
  try {
    const response = await fetch('/rooms') // simplified path
    const rooms = await response.json()
    
    const container = document.getElementById('activeRooms')
    
    if (!rooms || rooms.length === 0) {
      container.innerHTML = '<p style="color: #666;">No active rooms</p>'
      return
    }
    
    container.innerHTML = rooms.map(room => {
      const expiresIn = Math.max(0, Math.floor((new Date(room.expiresAt) - new Date()) / 1000 / 60))
      const badgeClass = `badge-${room.meetingType}`
      
      return `
        <div class="room-card" onclick="joinRoomById('${room.id}')" style="cursor:pointer; border:1px solid #ccc; padding:10px; margin:5px;">
          <div class="room-info">
            <h3>${room.title || room.id}</h3>
            <p>
              <span class="room-badge ${badgeClass}">${room.meetingType}</span>
              <span style="color: #999;">Room ID: ${room.id}</span>
            </p>
            <p style="font-size: 12px;">
              ${room.peerCount} participant${room.peerCount !== 1 ? 's' : ''} | 
              Expires in ${expiresIn} min
            </p>
          </div>
        </div>
      `
    }).join('')
  } catch (error) {
    console.error('Failed to load rooms:', error)
  }
}

function joinRoomById(roomId) {
  window.location.href = `/room.html?room=${encodeURIComponent(roomId)}`
}

function showCreateRoomModal() {
  document.getElementById('roomModal').style.display = 'block'
}

function closeModal() {
  document.getElementById('roomModal').style.display = 'none'
  document.getElementById('meetingTitle').value = ''
  document.getElementById('meetingType').value = ''
  document.getElementById('titleCounter').textContent = '0/100 characters'
}

function submitRoomDetails() {
  const title = document.getElementById('meetingTitle').value.trim()
  const type = document.getElementById('meetingType').value
  
  if (!title) {
    alert('Please enter a room title')
    return
  }
  if (!type) {
    alert('Please select a room type')
    return
  }
  
  // Generate random Room ID (12 chars)
  const roomName = Math.random().toString(36).substring(2, 8) + Math.random().toString(36).substring(2, 8);
  
  // Redirect
  window.location.href = `/room.html?room=${encodeURIComponent(roomName)}&title=${encodeURIComponent(title)}&type=${encodeURIComponent(type)}`
}

function joinExistingRoom() {
  const roomName = document.getElementById('roomInput').value.trim()
  if (!roomName) {
    alert('Please enter a room ID')
    return
  }
  window.location.href = `/room.html?room=${encodeURIComponent(roomName)}`
}
</script>
</body>
</html>